# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Google Cloud Storage –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π

## –û–±–∑–æ—Ä

–ë–æ—Ç —Ç–µ–ø–µ—Ä—å –∏–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–Ω —Å Google Cloud Storage (GCS) –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π. –≠—Ç–æ –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç:
- ‚úÖ –ù–∞–¥–µ–∂–Ω–æ–µ —Ö—Ä–∞–Ω–µ–Ω–∏–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –≤ –æ–±–ª–∞–∫–µ
- ‚úÖ –ü—É–±–ª–∏—á–Ω—ã–µ URL –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞
- ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
- ‚úÖ –ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å –±–µ–∑ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ –¥–∏—Å–∫–∞

## –ß—Ç–æ –±—ã–ª–æ —Å–¥–µ–ª–∞–Ω–æ

### 1. –°–æ–∑–¥–∞–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã

- **gcs_helper.py** - –º–æ–¥—É–ª—å –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å Google Cloud Storage
  - `upload_image()` - –∑–∞–≥—Ä—É–∑–∫–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –≤ GCS
  - `upload_pil_image()` - –∑–∞–≥—Ä—É–∑–∫–∞ PIL Image –≤ GCS
  - `delete_image()` - —É–¥–∞–ª–µ–Ω–∏–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
  - `delete_old_images()` - –∞–≤—Ç–æ–æ—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
  - `get_public_url()` - –ø–æ–ª—É—á–µ–Ω–∏–µ –ø—É–±–ª–∏—á–Ω–æ–≥–æ URL
  - `list_images()` - —Å–ø–∏—Å–æ–∫ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –≤ bucket

- **tgbots-google-cloud.json** - –∫—Ä–µ–¥–µ–Ω—à–∏–∞–ª—ã Google Cloud Service Account
  - Project ID: tgbots-478501
  - Service Account: telegram-bot-storage@tgbots-478501.iam.gserviceaccount.com

### 2. –û–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã

#### requirements.txt
```diff
+ # Google Cloud Storage
+ google-cloud-storage==2.14.0
```

#### settings.py
```python
# Google Cloud Storage –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
USE_GCS = os.getenv("USE_GCS", "true").lower() == "true"
GCS_BUCKET_NAME = os.getenv("GCS_BUCKET_NAME", "tgbots-images")
GCS_CREDENTIALS_PATH = os.getenv("GCS_CREDENTIALS_PATH", "tgbots-google-cloud.json")
```

#### bot.py
- –î–æ–±–∞–≤–ª–µ–Ω –∏–º–ø–æ—Ä—Ç `from gcs_helper import upload_image as gcs_upload_image`
- –§—É–Ω–∫—Ü–∏—è `upload_image_to_webapp()` –æ–±–Ω–æ–≤–ª–µ–Ω–∞ –¥–ª—è –ø–æ–¥–¥–µ—Ä–∂–∫–∏ GCS
- –ü—Ä–∏ `USE_GCS=true` –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è –Ω–∞–ø—Ä—è–º—É—é –≤ GCS –≤–º–µ—Å—Ç–æ –≤–µ–±-—Å–µ—Ä–≤–µ—Ä–∞

#### .env
```env
# Google Cloud Storage
USE_GCS=true
GCS_BUCKET_NAME=tgbots-images
GCS_CREDENTIALS_PATH=tgbots-google-cloud.json
```

## –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è Google Cloud Storage

### Bucket
- **–ù–∞–∑–≤–∞–Ω–∏–µ:** `tgbots-images`
- **–†–µ–≥–∏–æ–Ω:** us-central1
- **–ü—É–±–ª–∏—á–Ω—ã–π –¥–æ—Å—Ç—É–ø:** –í–∫–ª—é—á–µ–Ω (–¥–ª—è —á—Ç–µ–Ω–∏—è)
- **–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø–∞–ø–æ–∫:**
  ```
  tgbots-images/
  ‚îú‚îÄ‚îÄ inpaint/       # –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –¥–ª—è inpaint —Ä–µ–¥–∞–∫—Ç–æ—Ä–∞
  ‚îú‚îÄ‚îÄ generated/     # –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è (–±—É–¥—É—â–µ–µ)
  ‚îú‚îÄ‚îÄ uploads/       # –ó–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏ (–±—É–¥—É—â–µ–µ)
  ‚îî‚îÄ‚îÄ temp/          # –í—Ä–µ–º–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã (–±—É–¥—É—â–µ–µ)
  ```

### Service Account Permissions
Service Account `telegram-bot-storage@tgbots-478501.iam.gserviceaccount.com` –∏–º–µ–µ—Ç —Å–ª–µ–¥—É—é—â–∏–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è:
- Storage Object Admin - –ø–æ–ª–Ω—ã–π –¥–æ—Å—Ç—É–ø –∫ –æ–±—ä–µ–∫—Ç–∞–º –≤ bucket
- Storage Bucket Viewer - —á—Ç–µ–Ω–∏–µ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö bucket

## –ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç

### –ó–∞–≥—Ä—É–∑–∫–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –¥–ª—è Inpaint Editor

1. **–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–∂–∏–º–∞–µ—Ç "üé® –î–æ—Ä–∏—Å–æ–≤–∞—Ç—å"**
2. **bot.py –≤—ã–∑—ã–≤–∞–µ—Ç `upload_image_to_webapp()`**
3. **–ü—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ `USE_GCS`:**
   - –ï—Å–ª–∏ `USE_GCS=true`:
     - –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è –≤ GCS —á–µ—Ä–µ–∑ `gcs_upload_image()`
     - –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è –ø—É–±–ª–∏—á–Ω—ã–π URL: `https://storage.googleapis.com/tgbots-images/inpaint/{uuid}.png`
     - URL –ø–µ—Ä–µ–¥–∞–µ—Ç—Å—è –≤ Mini App: `{WEBAPP_URL}/?image={gcs_url}&user_id={uid}`
   - –ï—Å–ª–∏ `USE_GCS=false`:
     - –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Å—Ç–∞—Ä—ã–π –º–µ—Ç–æ–¥ —á–µ—Ä–µ–∑ –ª–æ–∫–∞–ª—å–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ –≤–µ–±-—Å–µ—Ä–≤–µ—Ä–∞
4. **Mini App –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç—Å—è —Å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ–º –∏–∑ GCS**
5. **–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Ä–∏—Å—É–µ—Ç –º–∞—Å–∫—É –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –æ–±—Ä–∞—Ç–Ω–æ –±–æ—Ç—É**

## –ü—É–±–ª–∏—á–Ω—ã–µ URL

–í—Å–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –≤ GCS –¥–æ—Å—Ç—É–ø–Ω—ã –ø–æ –ø—É–±–ª–∏—á–Ω—ã–º URL:
```
https://storage.googleapis.com/tgbots-images/{folder}/{filename}
```

–ù–∞–ø—Ä–∏–º–µ—Ä:
```
https://storage.googleapis.com/tgbots-images/inpaint/abc123def456.png
```

## –ê–≤—Ç–æ–æ—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π

–§—É–Ω–∫—Ü–∏—è `delete_old_images()` –º–æ–∂–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –æ—á–∏—Å—Ç–∫–∏ —Å—Ç–∞—Ä—ã—Ö —Ñ–∞–π–ª–æ–≤:

```python
from gcs_helper import delete_old_images

# –£–¥–∞–ª–∏—Ç—å —Ñ–∞–π–ª—ã —Å—Ç–∞—Ä—à–µ 7 –¥–Ω–µ–π
deleted_count = delete_old_images(folder="inpaint", days_old=7)
print(f"Deleted {deleted_count} old images")
```

–†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å cron job –¥–ª—è —Ä–µ–≥—É–ª—è—Ä–Ω–æ–π –æ—á–∏—Å—Ç–∫–∏:
```bash
# –ö–∞–∂–¥—ã–π –¥–µ–Ω—å –≤ 3:00 AM —É–¥–∞–ª—è—Ç—å —Ñ–∞–π–ª—ã —Å—Ç–∞—Ä—à–µ 7 –¥–Ω–µ–π
0 3 * * * cd /path/to/bot && python -c "from gcs_helper import delete_old_images; delete_old_images('inpaint', 7)"
```

## –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∏ –ª–æ–≥–∏

–í—Å–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ —Å GCS –ª–æ–≥–∏—Ä—É—é—Ç—Å—è –≤ –∫–æ–Ω—Å–æ–ª—å:
```
[INFO] Uploading image to Google Cloud Storage...
[OK] Image uploaded to GCS: https://storage.googleapis.com/tgbots-images/inpaint/abc123.png
```

–õ–æ–≥–∏ –º–æ–∂–Ω–æ –ø—Ä–æ—Å–º–æ—Ç—Ä–µ—Ç—å —á–µ—Ä–µ–∑ Docker:
```bash
docker compose logs -f telegram-bot | grep GCS
```

## –û—Ç–∫–ª—é—á–µ–Ω–∏–µ GCS (–≤–æ–∑–≤—Ä–∞—Ç –∫ –ª–æ–∫–∞–ª—å–Ω–æ–º—É —Ö—Ä–∞–Ω–∏–ª–∏—â—É)

–ß—Ç–æ–±—ã –≤–µ—Ä–Ω—É—Ç—å—Å—è –∫ –ª–æ–∫–∞–ª—å–Ω–æ–º—É —Ö—Ä–∞–Ω–∏–ª–∏—â—É –Ω–∞ –≤–µ–±-—Å–µ—Ä–≤–µ—Ä–µ:

1. –û–±–Ω–æ–≤–∏—Ç–µ `.env`:
   ```env
   USE_GCS=false
   ```

2. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ –±–æ—Ç:
   ```bash
   docker compose restart telegram-bot
   ```

–ë–æ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–µ—Ä–µ–∫–ª—é—á–∏—Ç—Å—è –Ω–∞ —Å—Ç–∞—Ä—ã–π –º–µ—Ç–æ–¥ –∑–∞–≥—Ä—É–∑–∫–∏ —á–µ—Ä–µ–∑ –≤–µ–±-—Å–µ—Ä–≤–µ—Ä.

## –°—Ç–æ–∏–º–æ—Å—Ç—å

Google Cloud Storage –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç –±–µ—Å–ø–ª–∞—Ç–Ω—ã–π –ø–ª–∞–Ω (Free Tier):
- **5 GB** —Ö—Ä–∞–Ω–∏–ª–∏—â–∞ (–†–µ–≥–∏–æ–Ω–∞–ª—å–Ω—ã–π storage)
- **1 GB** –∏—Å—Ö–æ–¥—è—â–µ–≥–æ —Ç—Ä–∞—Ñ–∏–∫–∞ –≤ –º–µ—Å—è—Ü
- **5,000** –æ–ø–µ—Ä–∞—Ü–∏–π Class A (—Å–æ–∑–¥–∞–Ω–∏–µ/–∏–∑–º–µ–Ω–µ–Ω–∏–µ)
- **50,000** –æ–ø–µ—Ä–∞—Ü–∏–π Class B (—á—Ç–µ–Ω–∏–µ)

–î–ª—è —Ç–µ–∫—É—â–µ–π –Ω–∞–≥—Ä—É–∑–∫–∏ –±–æ—Ç–∞ —ç—Ç–æ–≥–æ –±–æ–ª–µ–µ —á–µ–º –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ. –ü—Ä–∏ –ø—Ä–µ–≤—ã—à–µ–Ω–∏–∏ Free Tier —Å—Ç–æ–∏–º–æ—Å—Ç—å:
- **$0.020** –∑–∞ GB –≤ –º–µ—Å—è—Ü (Regional storage –≤ us-central1)
- **$0.004** –∑–∞ 1,000 –æ–ø–µ—Ä–∞—Ü–∏–π Class A
- **$0.0004** –∑–∞ 1,000 –æ–ø–µ—Ä–∞—Ü–∏–π Class B

## –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

‚ö†Ô∏è **–í–∞–∂–Ω–æ:**

1. **–ö—Ä–µ–¥–µ–Ω—à–∏–∞–ª—ã** (`tgbots-google-cloud.json`) –¥–æ–ª–∂–Ω—ã —Ö—Ä–∞–Ω–∏—Ç—å—Å—è –≤ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
2. **–ù–µ –∫–æ–º–º–∏—Ç–∏—Ç—å** –∫—Ä–µ–¥–µ–Ω—à–∏–∞–ª—ã –≤ git —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π
3. **Bucket –Ω–∞—Å—Ç—Ä–æ–µ–Ω –∫–∞–∫ –ø—É–±–ª–∏—á–Ω—ã–π** –¥–ª—è —á—Ç–µ–Ω–∏—è - —ç—Ç–æ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –¥–ª—è —Ä–∞–±–æ—Ç—ã Mini App
4. **Service Account** –∏–º–µ–µ—Ç –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è

## Troubleshooting

### –û—à–∏–±–∫–∞: "Failed to upload image to GCS"

–ü—Ä–æ–≤–µ—Ä—å—Ç–µ:
1. –§–∞–π–ª –∫—Ä–µ–¥–µ–Ω—à–∏–∞–ª–æ–≤ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –∏ –¥–æ—Å—Ç—É–ø–µ–Ω:
   ```bash
   ls -la tgbots-google-cloud.json
   ```
2. –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è –æ–∫—Ä—É–∂–µ–Ω–∏—è `GOOGLE_APPLICATION_CREDENTIALS` —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞ –ø—Ä–∞–≤–∏–ª—å–Ω–æ
3. Service Account –∏–º–µ–µ—Ç –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞

### –û—à–∏–±–∫–∞: "Bucket does not exist"

Bucket —Å–æ–∑–¥–∞–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏ –ø–µ—Ä–≤–æ–π –∑–∞–≥—Ä—É–∑–∫–µ. –ï—Å–ª–∏ –æ—à–∏–±–∫–∞ –ø–æ–≤—Ç–æ—Ä—è–µ—Ç—Å—è:
1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ bucket –≤ `.env`
2. –£–±–µ–¥–∏—Ç–µ—Å—å —á—Ç–æ Service Account –∏–º–µ–µ—Ç –ø—Ä–∞–≤–∞ –Ω–∞ —Å–æ–∑–¥–∞–Ω–∏–µ buckets
3. –°–æ–∑–¥–∞–π—Ç–µ bucket –≤—Ä—É—á–Ω—É—é —á–µ—Ä–µ–∑ Google Cloud Console

### –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –Ω–µ –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è –≤ Mini App

1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø—É–±–ª–∏—á–Ω—ã–π –¥–æ—Å—Ç—É–ø –∫ bucket:
   ```bash
   curl -I https://storage.googleapis.com/tgbots-images/inpaint/test.png
   ```
2. –£–±–µ–¥–∏—Ç–µ—Å—å —á—Ç–æ bucket –Ω–∞—Å—Ç—Ä–æ–µ–Ω –∫–∞–∫ –ø—É–±–ª–∏—á–Ω—ã–π –¥–ª—è —á—Ç–µ–Ω–∏—è
3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ CORS –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ bucket (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ)

## –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è

- [Google Cloud Storage Documentation](https://cloud.google.com/storage/docs)
- [Python Client Library](https://googleapis.dev/python/storage/latest/index.html)
- [Pricing Calculator](https://cloud.google.com/products/calculator)
