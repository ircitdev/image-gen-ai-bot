<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>–†–µ–¥–∞–∫—Ç–æ—Ä –º–∞—Å–∫–∏ Inpaint</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: var(--tg-theme-bg-color, #ffffff);
            color: var(--tg-theme-text-color, #000000);
            overflow: hidden;
            touch-action: none;
        }

        #app {
            display: flex;
            flex-direction: column;
            height: 100vh;
            max-height: 100vh;
        }

        #header {
            padding: 12px 16px;
            background-color: var(--tg-theme-secondary-bg-color, #f0f0f0);
            border-bottom: 1px solid var(--tg-theme-hint-color, #ccc);
        }

        #header h1 {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 4px;
        }

        #header p {
            font-size: 13px;
            color: var(--tg-theme-hint-color, #999);
        }

        #canvas-container {
            flex: 1;
            position: relative;
            overflow: hidden;
            background-color: #2a2a2a;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        #imageCanvas, #maskCanvas {
            position: absolute;
            touch-action: none;
        }

        #imageCanvas {
            z-index: 1;
        }

        #maskCanvas {
            z-index: 2;
            cursor: crosshair;
        }

        #controls {
            padding: 12px 16px;
            background-color: var(--tg-theme-secondary-bg-color, #f0f0f0);
            border-top: 1px solid var(--tg-theme-hint-color, #ccc);
        }

        .control-row {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 8px;
        }

        .control-row:last-child {
            margin-bottom: 0;
        }

        label {
            font-size: 14px;
            font-weight: 500;
            min-width: 80px;
        }

        input[type="range"] {
            flex: 1;
            height: 32px;
        }

        .brush-size-value {
            font-size: 14px;
            min-width: 45px;
            text-align: right;
            font-weight: 600;
        }

        .button-group {
            display: flex;
            gap: 8px;
        }

        button {
            flex: 1;
            padding: 10px 16px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: opacity 0.2s;
        }

        button:active {
            opacity: 0.7;
        }

        #clearBtn {
            background-color: var(--tg-theme-destructive-text-color, #ff3b30);
            color: white;
        }

        #undoBtn {
            background-color: var(--tg-theme-hint-color, #999);
            color: white;
        }

        .loading {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            color: white;
            font-size: 16px;
        }

        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <div id="app">
        <div id="header">
            <h1>üé® –†–µ–¥–∞–∫—Ç–æ—Ä –º–∞—Å–∫–∏</h1>
            <p>–ó–∞–∫—Ä–∞—Å—å—Ç–µ –æ–±–ª–∞—Å—Ç—å, –∫–æ—Ç–æ—Ä—É—é –Ω—É–∂–Ω–æ –∏–∑–º–µ–Ω–∏—Ç—å</p>
        </div>

        <div id="canvas-container">
            <canvas id="imageCanvas"></canvas>
            <canvas id="maskCanvas"></canvas>
        </div>

        <div id="controls">
            <div class="control-row">
                <label for="brushSize">–†–∞–∑–º–µ—Ä:</label>
                <input type="range" id="brushSize" min="5" max="100" value="30" step="5">
                <span class="brush-size-value" id="brushSizeValue">30px</span>
            </div>
            <div class="control-row button-group">
                <button id="undoBtn">‚Ü∂ –û—Ç–º–µ–Ω–∏—Ç—å</button>
                <button id="clearBtn">‚úï –û—á–∏—Å—Ç–∏—Ç—å</button>
            </div>
        </div>
    </div>

    <div id="loading" class="loading hidden">
        <div>–ó–∞–≥—Ä—É–∑–∫–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è...</div>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();
        tg.enableClosingConfirmation();

        // –ü–æ–ª—É—á–∞–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∏–∑ URL
        const urlParams = new URLSearchParams(window.location.search);
        const imageUrl = urlParams.get('image');
        const userId = urlParams.get('user_id');

        // Canvas —ç–ª–µ–º–µ–Ω—Ç—ã
        const imageCanvas = document.getElementById('imageCanvas');
        const maskCanvas = document.getElementById('maskCanvas');
        const imageCtx = imageCanvas.getContext('2d');
        const maskCtx = maskCanvas.getContext('2d');

        // –°–æ—Å—Ç–æ—è–Ω–∏–µ
        let isDrawing = false;
        let brushSize = 30;
        let image = null;
        let history = [];
        let currentHistoryIndex = -1;

        // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Ä–∞–∑–º–µ—Ä–∞ –∫–∏—Å—Ç–∏
        const brushSizeInput = document.getElementById('brushSize');
        const brushSizeValue = document.getElementById('brushSizeValue');

        brushSizeInput.addEventListener('input', (e) => {
            brushSize = parseInt(e.target.value);
            brushSizeValue.textContent = brushSize + 'px';
        });

        // –ó–∞–≥—Ä—É–∑–∫–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
        document.getElementById('loading').classList.remove('hidden');

        const img = new Image();
        img.crossOrigin = 'anonymous';
        img.onload = function() {
            image = img;
            setupCanvas();
            document.getElementById('loading').classList.add('hidden');
            saveHistory();
        };
        img.onerror = function() {
            tg.showAlert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è');
            tg.close();
        };
        img.src = imageUrl;

        function setupCanvas() {
            const container = document.getElementById('canvas-container');
            const containerWidth = container.clientWidth;
            const containerHeight = container.clientHeight;

            // –í—ã—á–∏—Å–ª—è–µ–º —Ä–∞–∑–º–µ—Ä—ã canvas —Å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º –ø—Ä–æ–ø–æ—Ä—Ü–∏–π
            let canvasWidth, canvasHeight;
            const imgRatio = image.width / image.height;
            const containerRatio = containerWidth / containerHeight;

            if (imgRatio > containerRatio) {
                canvasWidth = containerWidth;
                canvasHeight = containerWidth / imgRatio;
            } else {
                canvasHeight = containerHeight;
                canvasWidth = containerHeight * imgRatio;
            }

            // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ä–∞–∑–º–µ—Ä—ã –¥–ª—è –æ–±–æ–∏—Ö canvas
            [imageCanvas, maskCanvas].forEach(canvas => {
                canvas.width = image.width;
                canvas.height = image.height;
                canvas.style.width = canvasWidth + 'px';
                canvas.style.height = canvasHeight + 'px';
            });

            // –†–∏—Å—É–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
            imageCtx.drawImage(image, 0, 0);

            // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –º–∞—Å–∫—É (–ø—Ä–æ–∑—Ä–∞—á–Ω—ã–π —Ñ–æ–Ω)
            maskCtx.globalAlpha = 0.5;
        }

        // –ü–æ–ª—É—á–µ–Ω–∏–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç —Å —É—á–µ—Ç–æ–º –º–∞—Å—à—Ç–∞–±–∞
        function getCanvasCoordinates(e) {
            const rect = maskCanvas.getBoundingClientRect();
            const scaleX = maskCanvas.width / rect.width;
            const scaleY = maskCanvas.height / rect.height;

            let clientX, clientY;
            if (e.touches) {
                clientX = e.touches[0].clientX;
                clientY = e.touches[0].clientY;
            } else {
                clientX = e.clientX;
                clientY = e.clientY;
            }

            return {
                x: (clientX - rect.left) * scaleX,
                y: (clientY - rect.top) * scaleY
            };
        }

        // –†–∏—Å–æ–≤–∞–Ω–∏–µ –Ω–∞ –º–∞—Å–∫–µ
        function draw(e) {
            e.preventDefault();
            if (!isDrawing) return;

            const coords = getCanvasCoordinates(e);

            maskCtx.fillStyle = 'white';
            maskCtx.beginPath();
            maskCtx.arc(coords.x, coords.y, brushSize, 0, Math.PI * 2);
            maskCtx.fill();
        }

        // –°–æ–±—ã—Ç–∏—è —Ä–∏—Å–æ–≤–∞–Ω–∏—è
        maskCanvas.addEventListener('mousedown', (e) => {
            isDrawing = true;
            draw(e);
        });

        maskCanvas.addEventListener('mousemove', draw);

        maskCanvas.addEventListener('mouseup', () => {
            if (isDrawing) {
                isDrawing = false;
                saveHistory();
            }
        });

        maskCanvas.addEventListener('touchstart', (e) => {
            isDrawing = true;
            draw(e);
        }, { passive: false });

        maskCanvas.addEventListener('touchmove', draw, { passive: false });

        maskCanvas.addEventListener('touchend', () => {
            if (isDrawing) {
                isDrawing = false;
                saveHistory();
            }
        });

        // –ò—Å—Ç–æ—Ä–∏—è –¥–ª—è undo
        function saveHistory() {
            // –£–¥–∞–ª—è–µ–º –≤—Å–µ –¥–µ–π—Å—Ç–≤–∏—è –ø–æ—Å–ª–µ —Ç–µ–∫—É—â–µ–≥–æ –∏–Ω–¥–µ–∫—Å–∞
            history = history.slice(0, currentHistoryIndex + 1);

            // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
            history.push(maskCtx.getImageData(0, 0, maskCanvas.width, maskCanvas.height));
            currentHistoryIndex++;

            // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º —Ä–∞–∑–º–µ—Ä –∏—Å—Ç–æ—Ä–∏–∏
            if (history.length > 20) {
                history.shift();
                currentHistoryIndex--;
            }
        }

        // –û—Ç–º–µ–Ω–∏—Ç—å –ø–æ—Å–ª–µ–¥–Ω–µ–µ –¥–µ–π—Å—Ç–≤–∏–µ
        document.getElementById('undoBtn').addEventListener('click', () => {
            if (currentHistoryIndex > 0) {
                currentHistoryIndex--;
                maskCtx.putImageData(history[currentHistoryIndex], 0, 0);
            }
        });

        // –û—á–∏—Å—Ç–∏—Ç—å –º–∞—Å–∫—É
        document.getElementById('clearBtn').addEventListener('click', () => {
            maskCtx.clearRect(0, 0, maskCanvas.width, maskCanvas.height);
            saveHistory();
        });

        // –ì–ª–∞–≤–Ω–∞—è –∫–Ω–æ–ø–∫–∞ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –º–∞—Å–∫–∏
        tg.MainButton.setText('–ì–æ—Ç–æ–≤–æ');
        tg.MainButton.show();
        tg.MainButton.onClick(() => {
            tg.MainButton.showProgress();

            // –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º –º–∞—Å–∫—É –≤ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
            const maskDataUrl = maskCanvas.toDataURL('image/png');

            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –±–æ—Ç—É
            tg.sendData(JSON.stringify({
                user_id: userId,
                mask: maskDataUrl
            }));
        });

        // –ò–∑–º–µ–Ω–µ–Ω–∏–µ —Ä–∞–∑–º–µ—Ä–∞ –æ–∫–Ω–∞
        window.addEventListener('resize', () => {
            if (image) {
                setupCanvas();
                if (currentHistoryIndex >= 0) {
                    maskCtx.putImageData(history[currentHistoryIndex], 0, 0);
                }
            }
        });
    </script>
</body>
</html>
